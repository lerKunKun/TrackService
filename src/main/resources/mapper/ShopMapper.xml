<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.logistics.track17.mapper.ShopMapper">

    <resultMap id="BaseResultMap" type="com.logistics.track17.entity.Shop">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="shop_name" property="shopName"/>
        <result column="platform" property="platform"/>
        <result column="shop_url" property="storeUrl"/>
        <result column="shop_domain" property="shopDomain"/>
        <result column="timezone" property="timezone"/>
        <result column="api_key" property="apiKey"/>
        <result column="api_secret" property="apiSecret"/>
        <result column="access_token" property="accessToken"/>
        <result column="token_type" property="tokenType"/>
        <result column="connection_status" property="connectionStatus"/>
        <result column="last_validated_at" property="lastValidatedAt"/>
        <result column="webhook_secret" property="webhookSecret"/>
        <result column="oauth_state" property="oauthState"/>
        <result column="oauth_scope" property="oauthScope"/>
        <result column="token_expires_at" property="tokenExpiresAt"/>
        <!-- Shopify商店详细信息字段 -->
        <result column="contact_email" property="contactEmail"/>
        <result column="owner_email" property="ownerEmail"/>
        <result column="currency" property="currency"/>
        <result column="plan_name" property="planName"/>
        <result column="plan_display_name" property="planDisplayName"/>
        <result column="is_shopify_plus" property="isShopifyPlus"/>
        <result column="primary_domain" property="primaryDomain"/>
        <result column="shop_owner" property="shopOwner"/>
        <result column="iana_timezone" property="ianaTimezone"/>
        <result column="shop_info_json" property="shopInfoJson"/>
        <result column="is_active" property="isActive"/>
        <result column="last_sync_time" property="lastSyncTime"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="deleted_at" property="deletedAt"/>
    </resultMap>

    <!-- 基础列表（用于列表查询，不包含敏感信息） -->
    <sql id="Base_Column_List">
        id, user_id, shop_name, platform, shop_url, shop_domain, primary_domain, timezone,
        currency, plan_display_name, contact_email,
        connection_status, is_active, last_sync_time, created_at, updated_at, deleted_at
    </sql>

    <!-- 详细列表（用于详情查询，包含所有字段） -->
    <sql id="Detail_Column_List">
        id, user_id, shop_name, platform, shop_url, shop_domain, timezone,
        api_key, api_secret, access_token, token_type, connection_status,
        last_validated_at, webhook_secret, oauth_state, oauth_scope,
        token_expires_at,
        contact_email, owner_email, currency, plan_name, plan_display_name,
        is_shopify_plus, primary_domain, shop_owner, iana_timezone, shop_info_json,
        is_active, last_sync_time, created_at, updated_at, deleted_at
    </sql>

    <insert id="insert" parameterType="com.logistics.track17.entity.Shop" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO shops (user_id, shop_name, platform, shop_url, shop_domain, timezone,
                           api_key, api_secret, access_token, token_type, connection_status, last_validated_at,
                           webhook_secret, oauth_state, oauth_scope, token_expires_at,
                           contact_email, owner_email, currency, plan_name, plan_display_name,
                           is_shopify_plus, primary_domain, shop_owner, iana_timezone, shop_info_json,
                           is_active, last_sync_time)
        VALUES (#{userId}, #{shopName}, #{platform}, #{storeUrl}, #{shopDomain}, #{timezone},
                #{apiKey}, #{apiSecret}, #{accessToken}, #{tokenType}, #{connectionStatus}, #{lastValidatedAt},
                #{webhookSecret}, #{oauthState}, #{oauthScope}, #{tokenExpiresAt},
                #{contactEmail}, #{ownerEmail}, #{currency}, #{planName}, #{planDisplayName},
                #{isShopifyPlus}, #{primaryDomain}, #{shopOwner}, #{ianaTimezone}, #{shopInfoJson},
                #{isActive}, #{lastSyncTime})
    </insert>

    <!-- 根据ID查询店铺 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM shops
        WHERE id = #{id}
    </select>

    <!-- 查询所有店铺 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM shops
        ORDER BY id DESC
    </select>

    <select id="selectByShopDomain" resultMap="BaseResultMap">
        SELECT <include refid="Detail_Column_List"/>
        FROM shops WHERE shop_domain = #{shopDomain} AND deleted_at IS NULL
    </select>

    <select id="selectList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM shops
        <where>
            deleted_at IS NULL
            <if test="platform != null and platform != ''">
                AND platform = #{platform}
            </if>
        </where>
        ORDER BY created_at DESC
        <if test="offset != null and pageSize != null">
            LIMIT #{offset}, #{pageSize}
        </if>
    </select>

    <select id="count" resultType="java.lang.Long">
        SELECT COUNT(*) FROM shops
        <where>
            deleted_at IS NULL
            <if test="platform != null and platform != ''">
                AND platform = #{platform}
            </if>
        </where>
    </select>

    <update id="update" parameterType="com.logistics.track17.entity.Shop">
        UPDATE shops
        <set>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="shopName != null">shop_name = #{shopName},</if>
            <if test="platform != null">platform = #{platform},</if>
            <if test="storeUrl != null">shop_url = #{storeUrl},</if>
            <if test="shopDomain != null">shop_domain = #{shopDomain},</if>
            <if test="timezone != null">timezone = #{timezone},</if>
            <if test="apiKey != null">api_key = #{apiKey},</if>
            <if test="apiSecret != null">api_secret = #{apiSecret},</if>
            <if test="accessToken != null">access_token = #{accessToken},</if>
            <if test="tokenType != null">token_type = #{tokenType},</if>
            <if test="connectionStatus != null">connection_status = #{connectionStatus},</if>
            <if test="lastValidatedAt != null">last_validated_at = #{lastValidatedAt},</if>
            <if test="webhookSecret != null">webhook_secret = #{webhookSecret},</if>
            <if test="oauthState != null">oauth_state = #{oauthState},</if>
            <if test="oauthScope != null">oauth_scope = #{oauthScope},</if>
            <if test="tokenExpiresAt != null">token_expires_at = #{tokenExpiresAt},</if>
            <if test="isActive != null">is_active = #{isActive},</if>
            <if test="lastSyncTime != null">last_sync_time = #{lastSyncTime},</if>
            <if test="contactEmail != null">contact_email = #{contactEmail},</if>
            <if test="ownerEmail != null">owner_email = #{ownerEmail},</if>
            <if test="currency != null">currency = #{currency},</if>
            <if test="planName != null">plan_name = #{planName},</if>
            <if test="planDisplayName != null">plan_display_name = #{planDisplayName},</if>
            <if test="isShopifyPlus != null">is_shopify_plus = #{isShopifyPlus},</if>
            <if test="primaryDomain != null">primary_domain = #{primaryDomain},</if>
            <if test="shopOwner != null">shop_owner = #{shopOwner},</if>
            <if test="ianaTimezone != null">iana_timezone = #{ianaTimezone},</if>
            <if test="shopInfoJson != null">shop_info_json = #{shopInfoJson},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 软删除店铺 -->
    <update id="deleteById">
        UPDATE shops SET deleted_at = NOW() WHERE id = #{id}
    </update>

    <select id="countOrdersByShopId" resultType="java.lang.Long">
        SELECT COUNT(*) FROM orders WHERE shop_id = #{shopId}
    </select>

</mapper>
