<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.logistics.track17.mapper.TrackingNumberMapper">

    <resultMap id="BaseResultMap" type="com.logistics.track17.entity.TrackingNumber">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="parcel_id" property="parcelId"/>
        <result column="tracking_number" property="trackingNumber"/>
        <result column="carrier_code" property="carrierCode"/>
        <result column="carrier_name" property="carrierName"/>
        <result column="carrier_id" property="carrierId"/>
        <result column="source" property="source"/>
        <result column="remarks" property="remarks"/>
        <result column="track_status" property="trackStatus"/>
        <result column="sub_status" property="subStatus"/>
        <result column="sub_status_descr" property="subStatusDescr"/>
        <result column="days_of_transit" property="daysOfTransit"/>
        <result column="days_after_last_update" property="daysAfterLastUpdate"/>
        <result column="latest_event_time" property="latestEventTime"/>
        <result column="latest_event_desc" property="latestEventDesc"/>
        <result column="latest_event_location" property="latestEventLocation"/>
        <result column="pickup_time" property="pickupTime"/>
        <result column="delivered_time" property="deliveredTime"/>
        <result column="last_sync_at" property="lastSyncAt"/>
        <result column="next_sync_at" property="nextSyncAt"/>
        <result column="raw_status" property="rawStatus"/>
        <result column="destination_country" property="destinationCountry"/>
        <result column="origin_country" property="originCountry"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="version" property="version"/>
    </resultMap>

    <insert id="insert" parameterType="com.logistics.track17.entity.TrackingNumber" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO tracking_numbers (
            parcel_id, tracking_number, carrier_code, carrier_id, source, remarks, track_status,
            sub_status, origin_country, destination_country
        )
        VALUES (
            #{parcelId}, #{trackingNumber}, #{carrierCode}, #{carrierId}, #{source}, #{remarks}, #{trackStatus},
            #{subStatus}, #{originCountry}, #{destinationCountry}
        )
    </insert>

    <insert id="insertBatch" parameterType="java.util.List">
        INSERT INTO tracking_numbers (
            parcel_id, tracking_number, carrier_code, carrier_id, source, remarks, track_status,
            sub_status, origin_country, destination_country
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.parcelId}, #{item.trackingNumber}, #{item.carrierCode}, #{item.carrierId},
                #{item.source}, #{item.remarks}, #{item.trackStatus}, #{item.subStatus},
                #{item.originCountry}, #{item.destinationCountry}
            )
        </foreach>
    </insert>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM tracking_numbers WHERE id = #{id}
    </select>

    <select id="selectByTrackingNumber" resultMap="BaseResultMap">
        SELECT * FROM tracking_numbers WHERE tracking_number = #{trackingNumber}
    </select>

    <select id="selectByTrackingNumbers" resultMap="BaseResultMap">
        SELECT * FROM tracking_numbers
        WHERE tracking_number IN
        <foreach collection="trackingNumbers" item="trackingNumber" open="(" separator="," close=")">
            #{trackingNumber}
        </foreach>
    </select>

    <select id="selectList" resultMap="BaseResultMap">
        SELECT tn.* FROM tracking_numbers tn
        <if test="shopId != null or (keyword != null and keyword != '')">
            LEFT JOIN parcels p ON tn.parcel_id = p.id
        </if>
        <if test="shopId != null">
            LEFT JOIN orders o ON p.order_id = o.id
        </if>
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                    tn.tracking_number LIKE CONCAT(#{keyword}, '%')
                    <if test="shopId != null">
                        OR o.order_id LIKE CONCAT(#{keyword}, '%')
                    </if>
                )
            </if>
            <if test="shopId != null">
                AND o.shop_id = #{shopId}
            </if>
            <if test="status != null and status != ''">
                AND tn.track_status = #{status}
            </if>
            <if test="carrierCode != null and carrierCode != ''">
                AND tn.carrier_code = #{carrierCode}
            </if>
            <if test="startDate != null and startDate != ''">
                AND tn.created_at >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND tn.created_at &lt;= #{endDate}
            </if>
        </where>
        ORDER BY tn.updated_at DESC
        <if test="offset != null and pageSize != null">
            LIMIT #{offset}, #{pageSize}
        </if>
    </select>

    <select id="count" resultType="java.lang.Long">
        SELECT COUNT(*) FROM tracking_numbers tn
        <if test="shopId != null or (keyword != null and keyword != '')">
            LEFT JOIN parcels p ON tn.parcel_id = p.id
        </if>
        <if test="shopId != null">
            LEFT JOIN orders o ON p.order_id = o.id
        </if>
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                    tn.tracking_number LIKE CONCAT(#{keyword}, '%')
                    <if test="shopId != null">
                        OR o.order_id LIKE CONCAT(#{keyword}, '%')
                    </if>
                )
            </if>
            <if test="shopId != null">
                AND o.shop_id = #{shopId}
            </if>
            <if test="status != null and status != ''">
                AND tn.track_status = #{status}
            </if>
            <if test="carrierCode != null and carrierCode != ''">
                AND tn.carrier_code = #{carrierCode}
            </if>
            <if test="startDate != null and startDate != ''">
                AND tn.created_at >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND tn.created_at &lt;= #{endDate}
            </if>
        </where>
    </select>

    <update id="update" parameterType="com.logistics.track17.entity.TrackingNumber">
        UPDATE tracking_numbers
        <set>
            <if test="trackStatus != null">track_status = #{trackStatus},</if>
            <if test="subStatus != null">sub_status = #{subStatus},</if>
            <if test="subStatusDescr != null">sub_status_descr = #{subStatusDescr},</if>
            <if test="daysOfTransit != null">days_of_transit = #{daysOfTransit},</if>
            <if test="daysAfterLastUpdate != null">days_after_last_update = #{daysAfterLastUpdate},</if>
            <if test="latestEventTime != null">latest_event_time = #{latestEventTime},</if>
            <if test="latestEventDesc != null">latest_event_desc = #{latestEventDesc},</if>
            <if test="latestEventLocation != null">latest_event_location = #{latestEventLocation},</if>
            <if test="pickupTime != null">pickup_time = #{pickupTime},</if>
            <if test="deliveredTime != null">delivered_time = #{deliveredTime},</if>
            <if test="lastSyncAt != null">last_sync_at = #{lastSyncAt},</if>
            <if test="nextSyncAt != null">next_sync_at = #{nextSyncAt},</if>
            <if test="rawStatus != null">raw_status = #{rawStatus},</if>
            <if test="carrierCode != null">carrier_code = #{carrierCode},</if>
            <if test="carrierId != null">carrier_id = #{carrierId},</if>
            <if test="carrierName != null">carrier_name = #{carrierName},</if>
            <if test="originCountry != null">origin_country = #{originCountry},</if>
            <if test="destinationCountry != null">destination_country = #{destinationCountry},</if>
            <if test="remarks != null">remarks = #{remarks},</if>
            version = version + 1,
        </set>
        WHERE id = #{id}
        <if test="version != null">
            AND version = #{version}
        </if>
    </update>

    <delete id="deleteById">
        DELETE FROM tracking_numbers WHERE id = #{id}
    </delete>

    <delete id="deleteBatch">
        DELETE FROM tracking_numbers WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="selectDistinctCarriers" resultType="java.lang.String">
        SELECT DISTINCT carrier_code
        FROM tracking_numbers
        WHERE carrier_code IS NOT NULL AND carrier_code != ''
        ORDER BY carrier_code
    </select>

</mapper>
