<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.logistics.track17.mapper.ProductShopMapper">

    <!-- Result Map -->
    <resultMap id="ProductShopResultMap" type="com.logistics.track17.entity.ProductShop">
        <id property="id" column="id"/>
        <result property="productId" column="product_id"/>
        <result property="shopId" column="shop_id"/>
        <result property="publishedBy" column="published_by"/>
        <result property="publishStatus" column="publish_status"/>
        <result property="lastExportTime" column="last_export_time"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 插入产品商店关联 -->
    <insert id="insert" parameterType="com.logistics.track17.entity.ProductShop" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO product_shops (product_id, shop_id, published_by, publish_status, last_export_time)
        VALUES (#{productId}, #{shopId}, #{publishedBy}, #{publishStatus}, #{lastExportTime})
    </insert>

    <!-- 批量插入关联关系 -->
    <insert id="batchInsert">
        INSERT INTO product_shops (product_id, shop_id, published_by, publish_status, last_export_time)
        VALUES
        <foreach collection="shopIds" item="shopId" separator=",">
            (#{productId}, #{shopId}, #{publishedBy}, #{publishStatus}, NOW())
        </foreach>
    </insert>

    <!-- 批量插入关联列表 -->
    <insert id="batchInsertList">
        INSERT INTO product_shops (product_id, shop_id, published_by, publish_status, last_export_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.productId}, #{item.shopId}, #{item.publishedBy}, #{item.publishStatus}, NOW())
        </foreach>
    </insert>

    <!-- 根据产品ID查询关联的所有商店ID -->
    <select id="selectShopIdsByProductId" resultType="java.lang.Long">
        SELECT shop_id FROM product_shops WHERE product_id = #{productId}
    </select>

    <!-- 根据商店ID查询关联的所有产品ID -->
    <select id="selectProductIdsByShopId" resultType="java.lang.Long">
        SELECT product_id FROM product_shops WHERE shop_id = #{shopId}
    </select>

    <!-- 根据产品ID列表批量查询商店关联 -->
    <select id="selectByProductIds" resultMap="ProductShopResultMap">
        SELECT * FROM product_shops 
        WHERE product_id IN
        <foreach collection="productIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 删除产品的所有商店关联 -->
    <delete id="deleteByProductId">
        DELETE FROM product_shops WHERE product_id = #{productId}
    </delete>

    <!-- 删除商店的所有产品关联 -->
    <delete id="deleteByShopId">
        DELETE FROM product_shops WHERE shop_id = #{shopId}
    </delete>

    <!-- 批量删除产品的商店关联 -->
    <delete id="deleteByProductIds">
        DELETE FROM product_shops WHERE product_id IN
        <foreach collection="productIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 删除指定的产品商店关联 -->
    <delete id="deleteByProductIdAndShopId">
        DELETE FROM product_shops WHERE product_id = #{productId} AND shop_id = #{shopId}
    </delete>

    <!-- 更新刊登状态 -->
    <update id="updatePublishStatus">
        UPDATE product_shops
        SET publish_status = #{status},
            last_export_time = #{lastExportTime},
            published_by = #{publishedBy}
        WHERE product_id = #{productId} AND shop_id = #{shopId}
    </update>

</mapper>
