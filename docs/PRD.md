# 物流追踪系统 PRD (产品需求文档)

## 1. 产品概述

### 1.1 产品定位
物流追踪系统是一个面向跨境电商店铺的运单管理和追踪平台，通过集成17Track API和Shopify等电商平台，实现运单的自动化监控和可视化管理。

### 1.2 目标用户
- 跨境电商运营人员
- 客服人员
- 店铺管理员

### 1.3 核心价值
- 集中管理多个Shopify店铺的运单信息
- 实时监控物流状态，及时发现异常
- 提供清晰的物流轨迹展示
- 支持批量导入导出，提高工作效率

## 2. 功能需求

### 2.1 店铺管理

#### 2.1.1 添加店铺
- 支持添加Shopify、Shopline、TikTok Shop等平台店铺
- 需配置店铺名称、平台类型、API密钥等信息
- 支持多店铺管理

#### 2.1.2 店铺列表
- 展示所有已添加的店铺
- 显示店铺基本信息和状态
- 支持编辑、删除操作

### 2.2 运单管理

#### 2.2.1 运单导入
- **CSV文件导入**：支持批量导入运单号
  - CSV格式要求：包含tracking_number、carrier_code等字段
  - 导入前验证数据格式
  - 显示导入结果统计（成功/失败数量）

- **单个添加**：手动输入单个运单信息
  - 必填字段：运单号、承运商代码
  - 可选字段：关联订单、备注等

- **自动同步**：从Shopify店铺自动获取订单和运单信息

#### 2.2.2 运单列表
- **分页展示**：所有运单以列表形式展示
  - 默认每页20条，支持切换分页大小
  - 支持快速跳转页码

- **列表字段**：
  - 运单号
  - 承运商
  - 当前状态
  - 最后更新时间
  - 关联订单号
  - 操作按钮

- **筛选功能**：
  - 按店铺筛选
  - 按状态筛选（运输中/已签收/异常等）
  - 按承运商筛选
  - 时间范围筛选

- **搜索功能**：
  - 支持运单号搜索
  - 支持订单号搜索

#### 2.2.3 运单详情
- **基本信息**：运单号、承运商、状态、时间等
- **物流轨迹**：
  - 时间轴展示物流节点
  - 每个节点显示：时间、状态、位置、描述
  - 按时间倒序排列（最新在上）
- **关联订单信息**：订单号、客户信息、商品信息

#### 2.2.4 运单操作
- **批量删除**：支持选择多个运单进行删除
- **单个删除**：删除单个运单
- **手动同步**：触发单个运单的状态更新
- **批量导出**：导出运单列表为CSV文件

### 2.3 17Track集成

#### 2.3.1 运单注册
- 新增运单时自动向17Track注册
- 支持批量注册
- 异常重试机制

#### 2.3.2 Webhook接收
- 接收17Track推送的运单状态更新
- 验证Webhook签名
- 记录Webhook日志
- 异步处理Webhook数据

#### 2.3.3 主动查询
- 定时任务：定期查询运单最新状态
- 手动触发查询
- 查询失败重试机制

### 2.4 订单管理

#### 2.4.1 订单列表
- 展示所有关联订单
- 显示订单基本信息和物流状态
- 支持按店铺、状态筛选

#### 2.4.2 订单详情
- 订单基本信息
- 关联的包裹和运单
- 物流状态汇总

### 2.5 数据统计（可选）
- 运单总数统计
- 各状态运单数量
- 异常运单统计
- 按承运商统计

## 3. 非功能需求

### 3.1 性能要求
- 列表页面加载时间 < 2秒
- Webhook处理响应时间 < 500ms
- 支持同时管理10000+运单
- 分页查询性能优化

### 3.2 可靠性要求
- **异常重试机制**：
  - API调用失败自动重试（最多3次）
  - 使用消息队列实现异步重试
  - 记录重试日志

- **数据一致性**：
  - 事务保证数据完整性
  - 幂等性设计（防止重复处理）

- **容错能力**：
  - 17Track API不可用时的降级处理
  - Webhook接收失败的补偿机制

### 3.3 安全要求
- API密钥加密存储
- Webhook签名验证
- 用户认证和授权
- SQL注入防护
- XSS防护

### 3.4 可扩展性
- 支持添加新的电商平台
- 支持添加新的物流服务商
- 微服务架构便于横向扩展

## 4. 技术架构

### 4.1 前端技术栈
- Vue 3
- Vite
- Element Plus / Ant Design Vue (UI组件库)
- Axios (HTTP客户端)
- Vue Router (路由)
- Pinia (状态管理)

### 4.2 后端技术栈
- Java 8+
- Spring Boot
- MyBatis
- MySQL 8.0
- Redis (缓存和分布式锁)
- RabbitMQ / Kafka (消息队列)
- RestTemplate / OkHttp (HTTP客户端)

### 4.3 数据存储
- **MySQL**：业务数据持久化
- **Redis**：
  - 缓存热点数据（运单状态、承运商信息）
  - 分布式锁
  - 消息队列（可选）

### 4.4 第三方集成
- 17Track API
- Shopify API
- Shopline API (可选)
- TikTok Shop API (可选)

## 5. 数据模型

### 5.1 核心实体
- **Shop（店铺）**：店铺基本信息和API配置
- **Order（订单）**：电商平台订单
- **Parcel（包裹）**：订单发货包裹
- **TrackingNumber（运单）**：物流追踪号
- **TrackingEvent（物流事件）**：物流轨迹节点
- **Carrier（承运商）**：物流承运商信息

### 5.2 关系说明
- 一个店铺有多个订单（1:N）
- 一个订单有多个包裹（1:N）
- 一个包裹有多个运单号（1:N）
- 一个运单号有多个物流事件（1:N）

## 6. 开发阶段规划

### 6.1 MVP阶段（第一期）
- ✅ 基础数据库设计
- ✅ 店铺管理（添加、列表）
- ✅ 运单导入（CSV、手动）
- ✅ 运单列表（分页、搜索、筛选）
- ✅ 运单详情（基本信息、物流轨迹）
- ✅ 17Track集成（注册、Webhook、查询）
- ✅ 批量删除运单
- ✅ 基础异常重试

### 6.2 第二期
- 自动同步Shopify订单
- 订单管理功能
- 数据统计看板
- 高级筛选和导出
- 性能优化

### 6.3 第三期
- 支持更多电商平台（Shopline、TikTok Shop）
- 地图展示物流轨迹
- 智能预警（延迟、异常）
- 报表功能

## 7. 关键流程

### 7.1 运单导入流程
1. 用户上传CSV文件或手动输入
2. 后端验证数据格式
3. 存储到数据库
4. 异步调用17Track注册接口
5. 返回导入结果

### 7.2 Webhook处理流程
1. 接收17Track Webhook请求
2. 验证签名
3. 记录日志到tracking_webhook_logs
4. 发送到消息队列（异步处理）
5. 立即返回200响应
6. 消费者处理消息：
   - 解析数据
   - 更新运单状态
   - 新增物流事件
   - 更新缓存

### 7.3 定时同步流程
1. 定时任务扫描需要同步的运单（next_sync_at）
2. 批量查询17Track API
3. 更新运单状态和事件
4. 失败重试（记录到sync_jobs）
5. 更新next_sync_at

## 8. API对接说明

### 8.1 17Track API
- **注册运单**：POST /track/v2.4/register
- **查询运单**：POST /track/v2.4/gettrackinfo
- **Webhook**：POST /webhook/tracking（我方提供）

### 8.2 Shopify API
- **获取订单列表**：GET /admin/api/2024-01/orders.json
- **获取订单详情**：GET /admin/api/2024-01/orders/{order_id}.json
- **获取Fulfillment**：GET /admin/api/2024-01/orders/{order_id}/fulfillments.json

## 9. 约束和限制

### 9.1 17Track限制
- API调用频率限制
- 单次注册运单数量限制
- Webhook超时时间要求

### 9.2 系统限制
- CSV文件大小限制：最大10MB
- 单次批量导入：最多1000条
- 运单号长度：最大200字符

## 10. 验收标准

### 10.1 功能验收
- ✅ 能够成功添加店铺并保存配置
- ✅ 能够通过CSV批量导入运单
- ✅ 运单列表正确展示，分页功能正常
- ✅ 运单详情页正确展示物流轨迹
- ✅ Webhook能够正确接收并处理17Track推送
- ✅ 批量删除功能正常
- ✅ 搜索和筛选功能正常

### 10.2 性能验收
- 列表查询1000条数据 < 2秒
- Webhook处理 < 500ms
- 批量导入100条 < 5秒

### 10.3 稳定性验收
- 异常重试机制有效
- 无数据丢失
- 并发访问稳定

## 11. 风险和挑战

### 11.1 技术风险
- 17Track API稳定性依赖
- 大数据量下的性能问题
- 消息队列消费速度

### 11.2 业务风险
- 不同承运商数据格式差异
- 物流信息更新延迟
- 用户数据安全

### 11.3 应对措施
- 实现降级方案和缓存机制
- 数据库索引优化和分库分表准备
- 消息队列监控和告警
- 数据加密和访问控制
